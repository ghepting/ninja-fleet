# checkout default branch if no arg provided, otherwise checkout target
gco() {
  if [ $# -eq 0 ]; then
    local target=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null | sed 's|^origin/||')
    git checkout "${target:-main}"
  else
    git checkout "$@"
  fi
}

gchanged() {
  if [ $# -ge 1 ]; then
    git diff-tree --no-commit-id --name-only -r "$1"
  else
    git diff-tree --no-commit-id --name-only -r HEAD
  fi
}

gbh() {
  local count=${1:-10}
  git for-each-ref --count="$count" --sort=-committerdate refs/heads/ --format="%(refname:short)"
}

myip() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    ipconfig getifaddr en0
  else
    ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1'
  fi
}

start() {
  cd ~/Development/"$1"
  dev
  tmux a -t dev || tmux new -s dev
}

catdir() {
  cat `ls -d "$1"/*.*`
}

set_term_title() {
  echo -ne "\033]0;${1:-title}\007"
}

set_term_tab_color() {
  if [ $# -eq 3 ]; then
    echo -e "\033]6;1;bg;red;brightness;$1\a"
    echo -e "\033]6;1;bg;green;brightness;$2\a"
    echo -e "\033]6;1;bg;blue;brightness;$3\a"
  else
    echo -e "\033]6;1;bg;*;default\a"
  fi
}

set_term_bgcolor() {
  if [ $# -eq 3 ]; then
    local R=$1 G=$2 B=$3
    osascript <<EOF
tell application "iTerm"
  tell the current window
    tell the current session
      set background color to {$(($R*65535/255)), $(($G*65535/255)), $(($B*65535/255))}
    end tell
  end tell
end tell
EOF
  fi
}

dev() {
  set_term_bgcolor 0 25 40
  set_term_title development
  set_term_tab_color 10 100 255
}

staging() {
  set_term_bgcolor 0 35 15
  set_term_title staging
  set_term_tab_color 120 255 120
}

prod() {
  set_term_bgcolor 38 8 0
  set_term_title production
  set_term_tab_color 255 40 40
}

mov2mp4() {
  if [ $# -ge 2 ]; then
    ffmpeg -i "$1" -preset fast -c:v libx264 -crf 20 -vf "scale=in_color_matrix=bt601:out_color_matrix=bt709" "$2"
  fi
}

weather() {
  local query=$(echo "${@:-?1Fu}" | sed 's/ /+/g')
  curl "wttr.in/$query"
}

cpu() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sysctl -n vm.loadavg
  else
    echo "CPU Load:  $(cat /proc/loadavg | awk '{print $1}')"
  fi
}

scruball() {
  sudo btrfs scrub start /
  sudo btrfs scrub start /mnt/storage
}

scrubstatus() {
  sudo -v || return 1
  echo "------------------------------------------------------"
  echo "ROOT (/)"
  sudo btrfs scrub status /
  echo "------------------------------------------------------"
  echo "STORAGE (/mnt/storage)"
  sudo btrfs scrub status /mnt/storage
  echo "------------------------------------------------------"
}

op-sudo-v() {
  op read "op://Development/LinuxUser/password" | sudo -S -v
}
