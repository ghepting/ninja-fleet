services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wg-easy
    network_mode: host
    env_file: .env.wireguard
    environment:
      - WG_HOST={{ wireguard_host | default('vpn.' + primary_domain) }}
      - WG_DEFAULT_ADDRESS={{ wireguard_default_address | default('10.0.0.x') }}
      - WG_DEFAULT_DNS={{ server_vpn_ip | default('10.0.0.1') }}
      - WG_ALLOWED_IPS={{ wireguard_allowed_ips | default('10.0.0.0/24, 192.168.1.0/24') }}
      - WG_PRE_UP=ip route replace {{ server_lan_subnet | default('192.168.1.0/24') }} dev {{ server_network_interface | default('eth0') }} src {{ server_lan_ip | default('192.168.1.2') }}
      - WG_POST_UP=iptables -t nat -A POSTROUTING -o {{ server_network_interface | default('eth0') }} -j MASQUERADE
      - WG_POST_DOWN=iptables -t nat -D POSTROUTING -o {{ server_network_interface | default('eth0') }} -j MASQUERADE
      - PORT=51821
      - WG_PORT=51820
    volumes:
      - /opt/homelab/services/wireguard/wg-easy/data:/etc/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
