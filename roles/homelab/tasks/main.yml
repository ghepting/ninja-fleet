---
- name: Homelab | Ensure Docker is running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true
  when: ansible_facts['os_family'] != 'Darwin'
  tags: [homelab, docker]

- name: Homelab | Install Python Docker dependencies
  ansible.builtin.apt:
    name: python3-docker
    state: present
    update_cache: true
  become: true
  when: ansible_facts['pkg_mgr'] == 'apt'
  tags: [homelab, docker]

- name: Homelab | Ensure project directory exists
  ansible.builtin.file:
    path: "{{ project_path }}"
    state: directory
    owner: "{{ admin_username }}"
    group: "{{ admin_group | default(admin_username) }}"
    mode: "0755"
  become: true
  tags: [homelab, config]

- name: Homelab | Create homelab services directory structure
  ansible.builtin.file:
    path: "{{ project_path }}/services/{{ item }}"
    state: directory
    owner: "{{ admin_username }}"
    mode: "0755"
  become: true
  loop:
    - caddy
    - wireguard
    - technitium
    - uptime-kuma
    - audiobookshelf
    - romm
  tags: [homelab, config]

- name: Homelab | Deploy main compose.yml
  ansible.builtin.copy:
    src: compose.yml
    dest: "{{ project_path }}/compose.yml"
    mode: "0644"
    owner: "{{ admin_username }}"
    group: "{{ admin_group | default(admin_username) }}"
  become: true
  tags: [homelab, docker, config]

# --- Logic: Overlays take precedence over Templates ---

- name: Homelab | Check for private service overlays
  ansible.builtin.stat:
    path: "{{ role_path }}/files/services/{{ item.service }}/{{ item.file }}"
  delegate_to: localhost
  register: homelab_service_overlays
  loop:
    - { service: "wireguard", file: "compose.yml" }
    - { service: "wireguard", file: ".env.wireguard" }
    - { service: "caddy", file: "compose.yml" }
    - { service: "caddy", file: "Caddyfile" }
    - { service: "technitium", file: "compose.yml" }
    - { service: "audiobookshelf", file: "compose.yml" }
  tags: [homelab, config, caddy, vpn, dns]

- name: Homelab | Deploy service templates (if no overlay exists)
  ansible.builtin.template:
    src: >-
      {{ (item.item.service + '-compose.yml.j2')
      if item.item.file == 'compose.yml' else
      ('wireguard.env.j2' if item.item.file == '.env.wireguard'
      else item.item.file + '.j2') }}
    dest: "{{ project_path }}/services/{{ item.item.service }}/{{ item.item.file }}"
    mode: "0644"
    owner: "{{ 'root' if item.item.service == 'caddy' else admin_username }}"
  when: not item.stat.exists
  loop: "{{ homelab_service_overlays.results }}"
  notify: Reload Caddy
  become: true
  tags: [homelab, config, caddy, vpn, dns]

- name: Homelab | Deploy service overlays (private configs)
  ansible.builtin.copy:
    src: "services/{{ item.item.service }}/{{ item.item.file }}"
    dest: "{{ project_path }}/services/{{ item.item.service }}/{{ item.item.file }}"
    mode: "0644"
    owner: "{{ 'root' if item.item.service == 'caddy' else admin_username }}"
  when: item.stat.exists
  loop: "{{ homelab_service_overlays.results }}"
  notify: Reload Caddy
  become: true
  tags: [homelab, config, caddy, vpn, dns]

- name: Homelab | Ensure SSL directory exists
  ansible.builtin.file:
    path: "{{ cert_path }}/caddy/certs"
    state: directory
    mode: "0755"
  become: true
  tags: [homelab, caddy, ssl]

- name: Homelab | Deploy Wildcard SSL Certificates
  ansible.builtin.copy:
    src: "certs/{{ item }}"
    dest: "{{ cert_path }}/caddy/certs/{{ item }}"
    mode: "0600"
    owner: root
  become: true
  loop:
    - "{{ primary_domain }}.crt"
    - "{{ primary_domain }}.key"
  notify: Reload Caddy
  tags: [homelab, caddy, ssl]

- name: Homelab | Ensure the homelab network exists
  community.docker.docker_network:
    name: homelab
    state: present
    driver: bridge
  become: true
  tags: [homelab, docker, network, caddy]

- name: Homelab | Deploy Homelab Stack via Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ project_path }}"
    files:
      - compose.yml
    state: present
  become: true
  tags: [homelab, docker, deploy, caddy, vpn, dns]
